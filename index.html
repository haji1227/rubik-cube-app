<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rubik's Cube Simulator - Commutator Enhanced</title>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 4px; margin: 0;
        }
        .container {
            max-width: 1200px; margin: 0 auto; background-color: rgba(255, 255, 255, 0.95);
            border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); overflow: hidden;
        }
        .header { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; text-align: center; padding: 10px; font-size: 18px; font-weight: 600; }
        .main-content { padding: 8px; }
        .cube-section {
            background: white; border-radius: 8px; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 8px; text-align: center;
        }
        .cube-section h3 { color: #333; margin-bottom: 6px; font-size: 14px; font-weight: 600; }
        .cube-container { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .cube { border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .controls-section {
            background: white; border-radius: 8px; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 8px; width: 100%; max-width: 420px;
        }
        .algorithm-display {
            background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 8px; margin-bottom: 8px;
            font-family: 'Courier New', monospace; font-size: 13px; min-height: 32px; word-wrap: break-word; text-align: center;
        }
        .commutator-section { background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .commutator-builder { display: grid; grid-template-columns: 1fr auto 1fr; gap: 4px; align-items: center; margin-bottom: 8px; }
        .commutator-input {
  text-align: center;       /* ‰∏≠Â§ÆÂØÑ„Åõ„ÇíÁ∂≠ÊåÅ */
  font-size: 14px;          
  line-height: 1.6;         
  padding: 8px 10px;        
  caret-color: #ff9800;     /* „Ç≠„É£„É¨„ÉÉ„Éà„ÇíË¶ã„ÇÑ„Åô„Åè */
}

        .commutator-operator { font-weight: bold; color: #ff9800; text-align: center; }
        .commutator-display {
            background: #fff8e1; border: 1px solid #ffcc02; border-radius: 6px; padding: 8px;
            font-family: 'Courier New', monospace; font-size: 12px; margin-bottom: 8px; text-align: center;
        }
        .button-grid { display: grid; gap: 4px; margin-bottom: 8px; }
        .face-buttons { grid-template-columns: repeat(6, 1fr); }
        .modifier-buttons { grid-template-columns: repeat(4, 1fr); }
        .rotation-buttons { grid-template-columns: repeat(3, 1fr); }
        .middle-buttons { grid-template-columns: repeat(3, 1fr); }
        .wide-buttons { grid-template-columns: repeat(6, 1fr); }
        button {
            padding: 8px 6px; border: none; border-radius: 4px; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease; min-height: 36px;
        }
        .move-btn { background: linear-gradient(45deg, #2196F3, #1976D2); color: white; }
        .move-btn:hover, .move-btn:active { background: linear-gradient(45deg, #1976D2, #2196F3); transform: translateY(-1px); }
        .modifier-btn { background: linear-gradient(45deg, #FF9800, #F57000); color: white; }
        .modifier-btn:hover, .modifier-btn:active { background: linear-gradient(45deg, #F57000, #FF9800); }
        .action-btn { background: linear-gradient(45deg, #E91E63, #C2185B); color: white; }
        .action-btn:hover, .action-btn:active { background: linear-gradient(45deg, #C2185B, #E91E63); }
        .commutator-btn { background: linear-gradient(45deg, #FF9800, #F57000); color: white; }
        .commutator-btn:hover, .commutator-btn:active { background: linear-gradient(45deg, #F57000, #FF9800); }
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; margin-bottom: 8px; }
        .setting-item {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: nowrap; /* „ÅØ„ÅøÂá∫„ÅóÈò≤Ê≠¢ */
}

.setting-item label {
  font-size: 11px;
  min-width: auto; /* Âõ∫ÂÆöÂπÖ„ÇÑ„ÇÅ„Çã */
}

.setting-item input[type=range] {
  flex: 1;
  min-width: 0;
}

.setting-item .value-display {
  padding: 2px 6px;
  font-size: 11px;
  min-width: auto;
}

        .slider { flex: 1; height: 6px; background: #ddd; border-radius: 3px; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; }
        .value-display { background: #4CAF50; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; min-width: 32px; text-align: center; }
        .preset-commutators {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 4px; margin-top: 0;
        }
        .preset-btn { background: linear-gradient(45deg, #673AB7, #5E35B1); color: white; padding: 6px 8px; font-size: 10px; text-align: left; }
        .preset-btn:hover { background: linear-gradient(45deg, #5E35B1, #673AB7); }
        @media (max-width: 768px) {
    .container { margin: 2px; border-radius: 8px; }
    .commutator-builder { gap: 2px; }
    .commutator-input { padding: 6px 4px; font-size: 12px; }
    .settings-grid { gap: 2px; }
    .setting-item { gap: 2px; }
    .setting-item label { font-size: 10px; }
    .face-buttons { grid-template-columns: repeat(3, 1fr) !important; }
    .wide-buttons { grid-template-columns: repeat(3, 1fr); }
    button { padding: 6px 3px; font-size: 10px; min-height: 30px; }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">üß© Rubik's Cube Simulator - Commutator Enhanced</div>
        
        <div class="main-content">
            <!-- Commutator Builder Section -->
            <div class="commutator-section">
                <h3>Commutator Builder [A, B] = A B A' B'</h3>

                <!-- Input Section -->
                <div class="commutator-builder">
                    <input type="text" id="sequenceA" class="commutator-input" placeholder="Sequence A" value="R U R'" inputmode="none">
                    <div class="commutator-operator" style="font-size: 16px;">,</div>
                    <input type="text" id="sequenceB" class="commutator-input" placeholder="Sequence B" value="D R' D'" inputmode="none">
                </div>

                <!-- Result and Actions -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="font-weight: bold; color: #ff9800;">=</div>
                    <input type="text" id="commutatorResult" class="commutator-input" style="flex: 1;" 
                           value="R U R' D R' D' R U' R' D R D'" 
                           placeholder="Generated result or enter custom algorithm" inputmode="none">
                </div>

                <!-- Quick Input Buttons („É©„Éô„É´ÂâäÈô§Ê∏à„Åø) -->
                <div class="button-grid face-buttons" style="margin-bottom: 8px;">
                    <button class="move-btn qi">R</button>
                    <button class="move-btn qi">U</button>
                    <button class="move-btn qi">D</button>
                    <button class="move-btn qi">L</button>
                    <button class="move-btn qi">F</button>
                    <button class="move-btn qi">B</button>
                    <button class="move-btn qi">x</button>
                    <button class="move-btn qi">y</button>
                </div>
                <div class="button-grid modifier-buttons" style="margin-bottom: 12px; grid-template-columns: repeat(5, 1fr);">
  <button class="modifier-btn qi">'</button>
  <button class="modifier-btn qi">2</button>
  <button class="modifier-btn qi">Space</button>
  <button class="modifier-btn" id="backspaceBtn">BS</button>
  <button class="action-btn" id="clearCurrent">Clear</button>
</div>


                <!-- Preset CommutatorsÔºà„É©„Éô„É´ÂâäÈô§Ê∏à„ÅøÔºâ -->
                <div class="preset-commutators" style="margin-bottom: 12px;">
                    <button class="preset-btn preset" data-a="R" data-b="U">sexy</button>
                    <button class="preset-btn preset" data-a="R U R'" data-b="D R' D'">RUD Basic</button>
                    <button class="preset-btn preset" data-a="R" data-b="U R U'">Corner 3-cycle</button>
                    <button class="preset-btn preset" data-a="R U' R'" data-b="F R F'">T-Perm Setup</button>
                    <button class="preset-btn preset" data-a="M'" data-b="U2 M U2">M-slice</button>
                </div>

                <div class="button-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <button class="commutator-btn op" data-op="ab">Gen A B</button>
                    <button class="commutator-btn op" data-op="conj">Gen A B A'</button>
                    <button class="commutator-btn op" data-op="comm">Gen [A,B]</button>
                    <button class="action-btn" id="setResult">Set</button>
                    <button class="action-btn" id="clearResult">Clear</button>
                </div>
            </div>

            <!-- Main Cube -->
            <div class="cube-section">
                <h3>Main Cube - Real-time Tracking</h3>
                <div class="cube-container">
                <div class="algorithm-display" id="algorithmDisplay">R U R' D R' D' R U' R' D R D'</div>
                    <div class="cube" style="width:350px; height:369px" id="mainCube">
                        <script>AnimCube3("move=R U R' D R' D' R U' R' D R D'&buttonbar=1&movetext=1&hint=6&scale=1&speed=12")</script>
                    </div>
                    
                    <div class="controls-section">
                        

                        <div class="settings-grid" style="grid-template-columns: repeat(2, 1fr);">
    <div class="setting-item">
        <label>Speed:</label>
        <input type="range" id="speed" min="1" max="25" value="12" class="slider">
        <span id="speedValue" class="value-display">12</span>
    </div>
    <div class="setting-item">
        <label>Hint:</label>
        <input type="range" id="hintLevel" min="0" max="15" value="6" class="slider">
        <span id="hintValue" class="value-display">6</span>
    </div>
</div>

                        
                    </div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="cube-section">
                <h3>Commutator Analysis</h3>
                <div style="display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 11px; margin-bottom: 4px; font-weight: 600;">After A</div>
                        <div class="cube" style="width:120px; height:139px" id="afterA">
                            <script>AnimCube3("move=R U R'&buttonbar=0&movetext=0&hint=0")</script>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; margin-bottom: 4px; font-weight: 600;">After A B</div>
                        <div class="cube" style="width:120px; height:139px" id="afterAB">
                            <script>AnimCube3("move=R U R' D R' D'&buttonbar=0&movetext=0&hint=0")</script>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 11px; margin-bottom: 4px; font-weight: 600;">Final [A,B]</div>
                        <div class="cube" style="width:120px; height:139px" id="finalCommutator">
                            <script>AnimCube3("move=R U R' D R' D' R U' R' D R D'&buttonbar=0&movetext=0&hint=0")</script>
                        </div>
                    </div>
                </div>
                <div style="background: #f0f8ff; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 11px; text-align: center;">
                    <div id="analysisInfo">Commutator [A,B] = A B A' B' analysis shown above</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://animcubejs.cubing.net/AnimCube3.js"></script>

    <script>
        // ==== Global state ====
        let currentAlgorithm = "R U R' D R' D' R U' R' D R D'";
        let showingMoveText = true;

        // „Éï„Ç©„Éº„Ç´„Çπ‰øùÊåÅÁî®
        let lastFocusedInput = null;
        let lastCaret = { start: null, end: null };

        // ==== Utility ====
        function parseSequence(sequence) { return sequence.trim(); }

        function invertSequence(sequence) {
            if (!sequence) return '';
            const moves = sequence.split(/\s+/).filter(m => m.length > 0);
            const inverted = moves.reverse().map(move => {
                if (move.endsWith("2'")) return move.slice(0, -2) + "2";
                if (move.endsWith("'")) return move.slice(0, -1);
                if (move.endsWith("2")) return move + "'";
                return move + "'";
            });
            return inverted.join(' ');
        }

        function wireCaretMemory() {
  ['sequenceA','sequenceB','commutatorResult'].forEach(id => {
    const el = document.getElementById(id);
    ['focus','click','keyup','select','input','mouseup'].forEach(ev => {
      el.addEventListener(ev, () => {
        lastFocusedInput = el;
        lastCaret.start = el.selectionStart;
        lastCaret.end = el.selectionEnd;
      });
    });
  });
}

// „Ç≠„É•„Éº„ÉñÊõ¥Êñ∞
function updateAllCubes(alg) {
  currentAlgorithm = alg;
  document.getElementById('algorithmDisplay').textContent = alg;
  document.getElementById('mainCube').innerHTML =
    `<script>AnimCube3("move=${alg}&buttonbar=1&movetext=1&hint=${document.getElementById('hintLevel').value}&scale=1&speed=${document.getElementById('speed').value}")<\/script>`;
}

// „ÄåSet„Äç„Éú„Çø„É≥„ÅßÁµêÊûúÊ¨Ñ„ÇíÂèçÊò†
document.getElementById('setResult').addEventListener('click', () => {
  const alg = document.getElementById('commutatorResult').value;
  updateAllCubes(alg);
});

// Quick Input Buttons
function insertAtCaret(text) {
  if (!lastFocusedInput) return;
  const el = lastFocusedInput;
  const start = el.selectionStart;
  const end = el.selectionEnd;
  const value = el.value;
  el.value = value.substring(0, start) + text + value.substring(end);
  el.selectionStart = el.selectionEnd = start + text.length;
  el.focus();
}
document.getElementById('backspaceBtn').addEventListener('click', () => {
  if (!lastFocusedInput) return;
  const el = lastFocusedInput;
  const start = el.selectionStart;
  const end = el.selectionEnd;
  if (start === end && start > 0) {
    el.value = el.value.substring(0, start - 1) + el.value.substring(end);
    el.selectionStart = el.selectionEnd = start - 1;
  } else {
    el.value = el.value.substring(0, start) + el.value.substring(end);
    el.selectionStart = el.selectionEnd = start;
  }
});
document.getElementById('clearCurrent').addEventListener('click', () => {
  if (!lastFocusedInput) return;
  lastFocusedInput.value = '';
});




        // ==== Quick Input insertion („Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆÁ∂≠ÊåÅ) ====
        function addToCurrentInput(move) {
    let input = null;
    if (lastFocusedInput && (lastFocusedInput.id === 'sequenceA' || lastFocusedInput.id === 'sequenceB' || lastFocusedInput.id === 'commutatorResult')) {
        input = lastFocusedInput;
    } else if (document.activeElement && (document.activeElement.id === 'sequenceA' || document.activeElement.id === 'sequenceB' || document.activeElement.id === 'commutatorResult')) {
        input = document.activeElement;
    } else {
        input = document.getElementById('sequenceA');
        input.focus();
        lastCaret.start = input.value.length;
        lastCaret.end = input.value.length;
    }

    const token = (move === 'Space') ? ' ' : move;

    const start = (lastCaret.start != null) ? lastCaret.start : input.selectionStart;
    const end = (lastCaret.end != null) ? lastCaret.end : input.selectionEnd;

    const text = input.value;
    input.value = text.slice(0, start) + token + text.slice(end);

    const newPos = start + token.length;
    input.selectionStart = newPos;
    input.selectionEnd = newPos;
    input.focus();

    lastFocusedInput = input;
    lastCaret.start = newPos;
    lastCaret.end = newPos;

    if (input.id === 'sequenceA' || input.id === 'sequenceB') {
       // generateCommutator();  // A/B„Å™„ÇâËá™ÂãïÁîüÊàêÊõ¥Êñ∞
    } else if (input.id === 'commutatorResult') {
       // currentAlgorithm = input.value;  // ÁµêÊûúÊ¨Ñ„ÅØ currentAlgorithm „ÇÇÊõ¥Êñ∞
      //  updateAlgorithmDisplay();
       // updateCube();
    }
}

        function clearCurrentInput() {
  const target = (lastFocusedInput && (['sequenceA','sequenceB','commutatorResult'].includes(lastFocusedInput.id)))
    ? lastFocusedInput : document.getElementById('sequenceA');
  target.value = '';
  target.focus();
  lastCaret.start = 0;
  lastCaret.end = 0;
  if (target.id === 'commutatorResult') {
   // currentAlgorithm = '';
   // updateAlgorithmDisplay();
   // updateCube();
  } else {
    //generateCommutator();
  }
}


        function backspaceCurrentInput() {
  let input = null;
  if (lastFocusedInput && (['sequenceA','sequenceB','commutatorResult'].includes(lastFocusedInput.id))) {
    input = lastFocusedInput;
  } else if (document.activeElement && (['sequenceA','sequenceB','commutatorResult'].includes(document.activeElement.id))) {
    input = document.activeElement;
  } else {
    input = document.getElementById('sequenceA');
    input.focus();
    lastCaret.start = input.value.length;
    lastCaret.end = input.value.length;
  }

  let start = (lastCaret.start != null) ? lastCaret.start : input.selectionStart;
  let end   = (lastCaret.end   != null) ? lastCaret.end   : input.selectionEnd;

  if (start === end && start > 0) {
    input.value = input.value.slice(0, start - 1) + input.value.slice(end);
    start--;
  } else if (start !== end) {
    input.value = input.value.slice(0, start) + input.value.slice(end);
  }

  input.selectionStart = start;
  input.selectionEnd   = start;
  input.focus();

  lastCaret.start = start;
  lastCaret.end   = start;

  if (input.id === 'commutatorResult') {
   // currentAlgorithm = input.value || '';
   // updateAlgorithmDisplay();
    //updateCube();
  } else {
    //setTimeout(generateCommutator, 0);
  }
}


        // ==== Commutator ops ====
        function generateCommutator() {
            const seqA = parseSequence(document.getElementById('sequenceA').value);
            const seqB = parseSequence(document.getElementById('sequenceB').value);
            if (!seqA || !seqB) {
                document.getElementById('commutatorResult').value = (seqA || seqB || '');
                updateCommutatorAnalysis(seqA || '', seqB || '', (seqA || seqB || ''));
                return;
            }
            const invA = invertSequence(seqA);
            const invB = invertSequence(seqB);
            const comm = `${seqA} ${seqB} ${invA} ${invB}`;
            document.getElementById('commutatorResult').value = comm;
            updateCommutatorAnalysis(seqA, seqB, comm);
        }

        function generateConjugate() {
            const seqA = parseSequence(document.getElementById('sequenceA').value);
            const seqB = parseSequence(document.getElementById('sequenceB').value);
            if (!seqA || !seqB) {
                alert('Please enter both sequences A and B');
                return;
            }
            const invA = invertSequence(seqA);
            const conj = `${seqA} ${seqB} ${invA}`;
            document.getElementById('commutatorResult').value = conj;
            updateConjugateAnalysis(seqA, seqB, conj);
        }

        function generateAB() {
            const seqA = parseSequence(document.getElementById('sequenceA').value);
            const seqB = parseSequence(document.getElementById('sequenceB').value);
            const pieces = [];
            if (seqA) pieces.push(seqA);
            if (seqB) pieces.push(seqB);
            const ab = pieces.join(' ');
            document.getElementById('commutatorResult').value = ab;
            // ÂàÜÊûêÊõ¥Êñ∞
            if (seqA) setTimeout(() => updateAnalysisCube('afterA', seqA), 100);
            else setTimeout(() => updateAnalysisCube('afterA', ''), 100);
            if (ab) {
                setTimeout(() => updateAnalysisCube('afterAB', ab), 200);
                setTimeout(() => updateAnalysisCube('finalCommutator', ab), 300);
            } else {
                setTimeout(() => updateAnalysisCube('afterAB', ''), 200);
                setTimeout(() => updateAnalysisCube('finalCommutator', ''), 300);
            }
            const info = document.getElementById('analysisInfo');
            if (info) {
                info.innerHTML = `<strong>A B Sequence:</strong><br>
                    A = ${seqA || '(empty)'}<br>
                    B = ${seqB || '(empty)'}<br>
                    A B = ${ab || '(empty)'}`;
            }
        }

        function setResult() {
            const result = document.getElementById('commutatorResult').value.trim();
            if (result) {
                currentAlgorithm = result;
                updateAlgorithmDisplay();
                updateCube();
            }
        }
        function clearResult() { document.getElementById('commutatorResult').value = ''; }

        function loadPresetCommutator(seqA, seqB) {
            document.getElementById('sequenceA').value = seqA;
            document.getElementById('sequenceB').value = seqB;
            // caret „ÇíÊú´Â∞æ„Å´
            const a = document.getElementById('sequenceA');
            a.focus();
            a.selectionStart = a.selectionEnd = a.value.length;
            lastFocusedInput = a;
            lastCaret.start = lastCaret.end = a.value.length;
            generateCommutator();
        }

        // ==== Analysis cubes ====
        function updateAnalysisCube(cubeId, algorithm) {
            const cubeDiv = document.getElementById(cubeId);
            if (!cubeDiv) return;
            cubeDiv.innerHTML = '';
            setTimeout(() => {
                const script = document.createElement('script');
                if (algorithm && algorithm.trim()) {
                    const encodedAlg = encodeURIComponent(algorithm.trim());
                    script.textContent = `AnimCube3("initmove=${encodedAlg}&buttonbar=0&movetext=0&hint=0");`;
                } else {
                    script.textContent = `AnimCube3("buttonbar=0&movetext=0&hint=0");`;
                }
                cubeDiv.appendChild(script);
            }, 50);
        }

        function updateCommutatorAnalysis(seqA, seqB, fullCommutator) {
            if (seqA) setTimeout(() => updateAnalysisCube('afterA', seqA), 100);
            else setTimeout(() => updateAnalysisCube('afterA', ''), 100);
            if (seqA && seqB) setTimeout(() => updateAnalysisCube('afterAB', `${seqA} ${seqB}`), 200);
            else setTimeout(() => updateAnalysisCube('afterAB', ''), 200);
            if (fullCommutator) setTimeout(() => updateAnalysisCube('finalCommutator', fullCommutator), 300);
            else setTimeout(() => updateAnalysisCube('finalCommutator', ''), 300);
            const info = document.getElementById('analysisInfo');
            if (info) {
                info.innerHTML = `<strong>Commutator Analysis:</strong><br>
                    A = ${seqA || '(empty)'}<br>
                    B = ${seqB || '(empty)'}<br>
                    [A,B] = A B A' B' = ${fullCommutator || '(empty)'}`;
            }
        }

        function updateConjugateAnalysis(seqA, seqB, conjugate) {
            if (seqA) setTimeout(() => updateAnalysisCube('afterA', seqA), 100);
            if (seqA && seqB) setTimeout(() => updateAnalysisCube('afterAB', `${seqA} ${seqB}`), 200);
            if (conjugate) setTimeout(() => updateAnalysisCube('finalCommutator', conjugate), 300);
            const info = document.getElementById('analysisInfo');
            if (info) {
                info.innerHTML = `<strong>Conjugate Analysis:</strong><br>
                    A = ${seqA}<br>
                    B = ${seqB}<br>
                    A B A' = ${conjugate}`;
            }
        }

        // ==== Main cube controls ====
        function addMove(token) {
            const t = (token === 'Space') ? ' ' : token;
            if (currentAlgorithm === "R U R' D R' D' R U' R' D R D'" && t.trim() !== '') {
                currentAlgorithm = '';
            }
            currentAlgorithm += t;
            updateAlgorithmDisplay();
            updateCube(); // Â∏∏„Å´ÂèçÊò†ÔºàSet„Éú„Çø„É≥ÂâäÈô§ÂØæÂøúÔºâ
        }

        function updateAlgorithmDisplay() {
            document.getElementById('algorithmDisplay').textContent = currentAlgorithm || '(empty)';
        }

        function toggleMoveText() { showingMoveText = !showingMoveText; updateCube(); }

        function updateCube() {
            const speed = document.getElementById('speed').value;
            const hint = document.getElementById('hintLevel').value;
            const algorithm = currentAlgorithm || '';
            const cubeDiv = document.getElementById('mainCube');
            cubeDiv.innerHTML = '';
            const moveTextParam = showingMoveText ? '&movetext=1' : '&movetext=0';
            const params = `move=${encodeURIComponent(algorithm)}&buttonbar=1&speed=${speed}&hint=${hint}&scale=0&buttonheight=25${moveTextParam}`;
            const script = document.createElement('script');
            script.textContent = `AnimCube3("${params}")`;
            cubeDiv.appendChild(script);
        }

        // ==== DOM Ready ====
        document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÊúüË°®Á§∫
    updateAlgorithmDisplay();

    // A„Å´„Éï„Ç©„Éº„Ç´„Çπ
    const a = document.getElementById('sequenceA');
    a.focus();
    a.selectionStart = a.selectionEnd = a.value.length;
    lastFocusedInput = a;
    lastCaret.start = lastCaret.end = a.value.length;

    wireCaretMemory();

    // --- „Éú„Çø„É≥„ÅÆ„Éï„Ç©„Éº„Ç´„ÇπÂ•™Âèñ„ÇíÂ∫ÉÁØÑÂõ≤„ÅßÈòªÊ≠¢ ---
    const selector = [
        '.face-buttons button',
        '.modifier-buttons button',
        '.preset-commutators .preset-btn',
        '.commutator-section .op',
        '.commutator-section #clearCurrent',
        '.commutator-section #setResult',
        '.commutator-section #clearResult',
        '.controls-section .add',
        '.controls-section #toggleNotation'
    ].join(',');

    document.querySelectorAll(selector).forEach(btn => {
        btn.addEventListener('mousedown', (e) => e.preventDefault());
        btn.setAttribute('tabindex', '-1');
    });

    // Quick Input „Éú„Çø„É≥„Å´Âãï‰Ωú‰ªò‰∏é
    document.querySelectorAll('.qi').forEach(b => {
        b.addEventListener('click', () => addToCurrentInput(b.textContent.trim()));
    });
    document.getElementById('clearCurrent').addEventListener('click', clearCurrentInput);
    document.getElementById('backspaceBtn').addEventListener('click', backspaceCurrentInput);

    // Preset Ë™≠„ÅøËæº„Åø
    document.querySelectorAll('.preset').forEach(b => {
        b.addEventListener('click', () => {
            loadPresetCommutator(b.dataset.a || '', b.dataset.b || '');
        });
    });

    // „Ç≥„Éü„É•„ÉÜ„Éº„ÇøÊìç‰ΩúÔºà„Éú„Çø„É≥Êäº„Åó„Åü„Å®„Åç„Å†„ÅëÁµêÊûúÊ¨ÑÊõ¥Êñ∞Ôºâ
    document.querySelectorAll('.op').forEach(b => {
        b.addEventListener('click', () => {
            const op = b.dataset.op;
            if (op === 'comm') generateCommutator();
            if (op === 'conj') generateConjugate();
            if (op === 'ab') generateAB();
        });
    });

    document.getElementById('setResult').addEventListener('click', setResult);
    document.getElementById('clearResult').addEventListener('click', clearResult);

    // Main controls
    document.querySelectorAll('.add').forEach(b => {
        b.addEventListener('click', () => addMove(b.textContent.trim()));
    });
    document.getElementById('toggleNotation').addEventListener('click', toggleMoveText);

    // „Çπ„É©„Ç§„ÉÄ„ÉºÈÄ£Âãï
    document.getElementById('speed').addEventListener('input', function() {
        document.getElementById('speedValue').textContent = this.value;
        updateCube();
    });
    document.getElementById('hintLevel').addEventListener('input', function() {
        document.getElementById('hintValue').textContent = this.value;
        updateCube();
    });

    // „Åì„Åì„ÅØÂâäÈô§ÔºàA/BÂ§âÊõ¥„ÅßËá™ÂãïÁîüÊàê„Åó„Å™„ÅÑÔºâ
    // document.getElementById('sequenceA').addEventListener('input', generateCommutator);
    // document.getElementById('sequenceB').addEventListener('input', generateCommutator);

    // Enter „Åß Set
    document.getElementById('commutatorResult').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') setResult();
    });
});

        // Ëß¶Ë¶öÊúÄÈÅ©Âåñ
        if ('ontouchstart' in window) { document.body.style.touchAction = 'manipulation'; }
    </script>
</body>
</html>
